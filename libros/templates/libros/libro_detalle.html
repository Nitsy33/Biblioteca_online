{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mt-5">

  <!-- üìò Informaci√≥n del libro -->
  <div class="card mb-4">
    <div class="row g-0">
      {% if libro.imagen_portada %}
        <div class="col-md-4">
          <img src="{{ libro.imagen_portada.url }}" class="img-fluid rounded-start" alt="Portada">
        </div>
      {% endif %}
      <div class="col-md-8">
        <div class="card-body">
          <h3 class="card-title">{{ libro.titulo }}</h3>
          <p class="card-text"><strong>Autor:</strong> {{ libro.autor.nombre }}</p>
          <p class="card-text"><strong>Editorial:</strong> {{ libro.editorial }}</p>
          <p class="card-text"><strong>Idioma:</strong> {{ libro.idioma }}</p>
          <p class="card-text"><strong>Fecha de emisi√≥n:</strong> {{ libro.fecha_emision }}</p>
          <p class="card-text"><strong>ISBN:</strong> {{ libro.isbn }}</p>
          <p class="card-text">{{ libro.descripcion }}</p>

          <!-- üì• Bot√≥n de descarga -->
          <a href="{{ libro.pdf_url.url }}" class="btn btn-success mt-2" download>üì• Descargar PDF</a>

          <!-- ‚≠ê Promedio de calificaci√≥n -->
          {% if promedio %}
            <p class="mt-2"><strong>Calificaci√≥n promedio:</strong> {{ promedio|floatformat:1 }} ‚≠ê</p>
          {% else %}
            <p class="mt-2 text-muted">Este libro a√∫n no tiene calificaciones.</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- ‚úç Formulario de calificaci√≥n y rese√±a -->
  <div class="card mb-4">
    <div class="card-header">Escribe tu rese√±a y calificaci√≥n</div>
    <div class="card-body">
      <form method="post">
        {% csrf_token %}

        <div class="mb-3">
          <label for="id_puntaje" class="form-label">Tu calificaci√≥n</label>
          {{ calificacion_form.puntaje }}
        </div>

        <div class="mb-3">
          <label for="id_comentario" class="form-label">Tu rese√±a</label>
          {{ rese√±a_form.comentario }}
        </div>

        <div class="form-check mb-3">
          {{ rese√±a_form.positiva }} 
          <label class="form-check-label" for="id_positiva">¬øRese√±a positiva?</label>
        </div>

        <button type="submit" class="btn btn-primary">Enviar</button>
      </form>
    </div>
  </div>

  <!-- üí¨ Rese√±as -->
  <h4>Rese√±as de usuarios:</h4>
  {% for rese√±a in rese√±as %}
    <div class="card mb-3">
      <div class="card-body">
        <h5 class="card-title">
          {{ rese√±a.usuario.username }}
          <small class="text-muted">{{ rese√±a.fecha|date:"d M Y H:i" }}</small>
        </h5>

        <!-- ‚≠ê Mostrar calificaci√≥n si existe -->
        {% if rese√±a.calificacion %}
          <p class="mb-1">Calificaci√≥n: {{ rese√±a.calificacion.puntaje }} ‚≠ê</p>
        {% endif %}

        <p class="card-text">{{ rese√±a.comentario }}</p>
        <p class="card-text">
          {% if rese√±a.positiva %}
            <span class="text-success">üëç Rese√±a positiva</span>
          {% else %}
            <span class="text-danger">üëé Rese√±a negativa</span>
          {% endif %}
        </p>
      </div>
    </div>
  {% empty %}
    <p class="text-muted">A√∫n no hay rese√±as.</p>
  {% endfor %}

</div>
{% endblock %}
